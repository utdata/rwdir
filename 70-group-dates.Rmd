---
output:
  pdf_document: default
  html_document: default
---

# Grouping by dates {#group-dates}

It is not uncommon in data journalism to count or sum records by year based on a date within your data. Or even by other date parts like month or week. There are some really nifty features within the [lubridate](https://lubridate.tidyverse.org/) package that make this pretty easy.

We'll run through some of those scenarios here using the Billboard Hot 100 data we used in Chapters 3 & 4. If you want to follow along, you can create a new notebook in your Billboard project. Or you can just use this for reference.

## Setting up

We need to set up our notebook with libraries and data before we can talk specifics. We need to load both the **tidyverse** and **lubridate** libraries. Lubridate is installed with the tidyverse package, but you have to load it separately.

```{r setup, echo=T, message=F, warning=F}
library(tidyverse)
library(lubridate)
```

And we need our cleaned Billboard Hot 100 data.

```{r import}
hot100 <- read_rds("data-processed/01-hot100.rds")

hot100 |> glimpse()
```

## Plucking date parts

If you look at the [lubridate cheetsheet](https://rawgit.com/rstudio/cheatsheets/main/lubridate.pdf) under "GET AND SET DATE COMPONENTS" you'll see functions to pluck out parts of a date, like `year()`.

If we have a date, like perhaps Taylor Swift's birthday, we can pluck the year from it.

```{r year-example}
year("1989-12-13")
```

## Grouping by a date part on the fly

Let's show how this might be useful through an example question:

**Which performer has the most appearances on the chart in a given year?**

The logic works like this: 

- Group all the records by `performer` AND the year of the `chart_date`
- Summarize and count the rows

```{r grp-year, warning=FALSE}
hot100 |> 
  group_by(
    year(chart_date),
    performer
  ) |> 
  summarize(appearances = n()) |> 
  arrange(desc(appearances))
```

We can see here that The Beatles had the most hits in 1964 with 214 (at least as of this writing).

But notice how the year column name is kinda shite? We would not be able to easily reference that variable later, so we should rename that AS we make the group:

```{r grp-year-betta}
hot100 |> 
  group_by(
    yr = year(chart_date), # added "yr = " here
    performer
  ) |> 
  summarize(appearances = n()) |> 
  arrange(desc(appearances))
```

It is a good practice to rename any grouping variable made from a function like that. FWIW, it would've worked if I called the new column `year`, but I named it `yr` so I'm less likely to confuse it with the function `year()`. It's a personal preference what to name the new column.

## Making reusable date parts

If you think you'll use a date parts more than once, then it makes sense to create a new columns and save them. You might make several date parts, but we'll start with only one.

**I usually go back to my cleaning notebook to add these once I recognize I need them, and then rerun everything.**

To make this easier to show, I've created a random sample of data with only the `chart_date` and `title` columns. Here is our sample:

```{r make-sample}
# you wouldn't normally do this!!!!
hot100_sample <- hot100 |> slice_sample(n = 6) |> select(chart_date, title)

hot100_sample
```

### Let's make a year

Here's how we do it:

- We use mutate to create a new column.
- We name the new column `yr`.
- We set the value of `yr` to equal the `year()` of `chart_date`.

```{r make-year}
hot100_sample |> 
  mutate(
    yr = year(chart_date)
  )
```

### The magical month

We can also pluck out the month of the date, which is pretty useful if you want to measure seasonality within a year, like hot days of summer, etc. The default `month()` function pulls the month as a number.

```{r}
hot100_sample |> 
  mutate(
    mo = month(chart_date)
  )
```

But there are some options within `month()` to give us month NAMES that are ordered as factors instead of alphabetical.

```{r}
hot100_sample |> 
  mutate(
    mo_label = month(chart_date, label = TRUE),
    mo_long = month(chart_date, label = TRUE, abbr = FALSE)
  ) |> 
  arrange(mo_label)
```

Note the datatype `<ord>` under the column `mo_label` and `mo_long`. That means this is an "ordered factor" and that when arranged by those labels it will list in MONTH order instead of alphabetical order, which is quite useful.

### Floor dates

Sometimes you want to count the number of records within a month and year, like all the songs in January 2000, then February 2000, etc. One way to do that is to create a floor_date, which gives you the "lowest" date within a certain unit like year or month. It's easiest to show with our sample data:

```{r date-floor}
hot100_sample |> 
  mutate(
    fl_month = floor_date(chart_date, unit = "month"),
    fl_year = floor_date(chart_date, unit = "year")
  )
```

You can see the resulting new columns are real dates, but they are normalized:

- The `fl_month` gives you the first day of the month for that `chart_date`.
- The `fl_year` gives you the first day of the year for that `chart_date`.

Let's put this to use with an example. I'll create a `fl_month` on the fly to find **Taylor Swift appearances by month for 2020-2021**. I'll also do the `year()` on the fly in my filter.

```{r swift-month}
swift_month <- hot100 |> 
  filter(
    performer == "Taylor Swift",
    year(chart_date) %in% 2020:2021
  ) |> 
  group_by(
    fl_month = floor_date(chart_date, unit = "month")
  ) |> 
  summarize(appearances = n())

swift_month
```

And chart it:

```{r}
swift_month |> 
  ggplot(aes(x = fl_month, y = appearances)) +
  geom_col() +
  geom_text(aes(label = appearances), vjust = -.3) +
  scale_x_date(date_labels="%b %Y",date_breaks  ="1 month") +
  guides(x =  guide_axis(angle = 45)) +
  labs(
    x = "Month and Year",
    y = "Hot 100 appearances",
    title = "Taylor Swift's Billboard Hot 100 appearances by month, 2020-2021"
  )
```

That tall bar with 28 appearances was right after "Folklore" [was released](https://en.wikipedia.org/wiki/Taylor_Swift_albums_discography#Studio_albums) in July 2020. There was another spike after "Evermore" was released in December 2020. We'll see what happened with "Midnights" once I update the data.

